# Makefile para IntegraÃ§Ã£o Casdoor com Spider-Gazelle

.PHONY: help install run test clean

# VariÃ¡veis
APP_NAME = spider-gazelle
APP_PORT = 3000
CASDOOR_URL = http://localhost:8000
APP_URL = http://localhost:$(APP_PORT)

# Comandos principais
help: ## Mostra esta ajuda
	@echo "Comandos disponÃ­veis:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

install: ## Instala dependÃªncias
	@echo "Instalando dependÃªncias..."
	shards install

run: ## Executa a aplicaÃ§Ã£o
	@echo "Executando aplicaÃ§Ã£o na porta $(APP_PORT)..."
	crystal src/app.cr

dev: ## Executa em modo desenvolvimento (com reload)
	@echo "Executando em modo desenvolvimento..."
	crystal src/app.cr --reload

dev-air: ## Executa com Air (hot reload)
	@echo "ğŸš€ Executando com Air (hot reload)..."
	@echo "ğŸ“ Monitorando alteraÃ§Ãµes em arquivos .cr, .ecr, .yml..."
	air

# Testes com curl
test: ## Executa todos os testes
	@echo "Executando testes..."
	@$(MAKE) test-home
	@$(MAKE) test-login
	@$(MAKE) test-dashboard-unauthorized
	@$(MAKE) test-profile-unauthorized
	@$(MAKE) test-logout
	@echo "âœ… Todos os testes passaram!"

test-home: ## Testa pÃ¡gina inicial
	@echo "ğŸ§ª Testando pÃ¡gina inicial..."
	@curl -s -o /dev/null -w "Status: %{http_code}\n" $(APP_URL)/ || echo "âŒ AplicaÃ§Ã£o nÃ£o estÃ¡ rodando"

test-login: ## Testa redirecionamento para login
	@echo "ğŸ§ª Testando redirecionamento para login..."
	@curl -s -o /dev/null -w "Status: %{http_code}\n" $(APP_URL)/login || echo "âŒ AplicaÃ§Ã£o nÃ£o estÃ¡ rodando"

test-dashboard-unauthorized: ## Testa acesso nÃ£o autorizado ao dashboard
	@echo "ğŸ§ª Testando acesso nÃ£o autorizado ao dashboard..."
	@curl -s -o /dev/null -w "Status: %{http_code}\n" $(APP_URL)/dashboard || echo "âŒ AplicaÃ§Ã£o nÃ£o estÃ¡ rodando"

test-profile-unauthorized: ## Testa acesso nÃ£o autorizado ao perfil
	@echo "ğŸ§ª Testando acesso nÃ£o autorizado ao perfil..."
	@curl -s -o /dev/null -w "Status: %{http_code}\n" $(APP_URL)/profile || echo "âŒ AplicaÃ§Ã£o nÃ£o estÃ¡ rodando"

test-logout: ## Testa logout
	@echo "ğŸ§ª Testando logout..."
	@curl -s -o /dev/null -w "Status: %{http_code}\n" $(APP_URL)/logout || echo "âŒ AplicaÃ§Ã£o nÃ£o estÃ¡ rodando"

test-callback: ## Testa callback OAuth (sem parÃ¢metros)
	@echo "ğŸ§ª Testando callback OAuth..."
	@curl -s -o /dev/null -w "Status: %{http_code}\n" $(APP_URL)/auth/callback || echo "âŒ AplicaÃ§Ã£o nÃ£o estÃ¡ rodando"

test-casdoor: ## Testa se Casdoor estÃ¡ rodando
	@echo "ğŸ§ª Testando conexÃ£o com Casdoor..."
	@curl -s -o /dev/null -w "Status: %{http_code}\n" $(CASDOOR_URL) || echo "âŒ Casdoor nÃ£o estÃ¡ rodando"

# Comandos de desenvolvimento
check: ## Verifica sintaxe e estilo do cÃ³digo
	@echo "Verificando cÃ³digo..."
	crystal tool format --check
	ameba

format: ## Formata o cÃ³digo
	@echo "Formatando cÃ³digo..."
	crystal tool format

# Comandos de limpeza
clean: ## Limpa arquivos temporÃ¡rios
	@echo "Limpa arquivos temporÃ¡rios..."
	rm -rf .crystal
	rm -rf lib
	rm -rf bin

clean-cache: ## Limpa cache do Crystal
	@echo "ğŸ§¹ Limpando cache do Crystal..."
	rm -rf ~/.cache/crystal
	rm -rf tmp/
	rm -rf .crystal/
	@echo "âœ… Cache limpo!"

# Comandos de debug
logs: ## Mostra logs da aplicaÃ§Ã£o
	@echo "Logs da aplicaÃ§Ã£o:"
	@tail -f logs/app.log 2>/dev/null || echo "Arquivo de log nÃ£o encontrado"

status: ## Mostra status dos serviÃ§os
	@echo "ğŸ“Š Status dos serviÃ§os:"
	@echo "AplicaÃ§Ã£o: $(shell curl -s -o /dev/null -w "%{http_code}" $(APP_URL) 2>/dev/null || echo "Parada")"
	@echo "Casdoor: $(shell curl -s -o /dev/null -w "%{http_code}" $(CASDOOR_URL) 2>/dev/null || echo "Parado")"

# Comandos de curl Ãºteis
curl-home: ## Testa pÃ¡gina inicial com curl detalhado
	@echo "ğŸ” Testando pÃ¡gina inicial..."
	@curl -v $(APP_URL)/

curl-login: ## Testa redirecionamento de login
	@echo "ğŸ” Testando redirecionamento de login..."
	@curl -v $(APP_URL)/login

curl-dashboard: ## Testa dashboard (requer autenticaÃ§Ã£o)
	@echo "ğŸ” Testando dashboard..."
	@curl -v $(APP_URL)/dashboard

curl-profile: ## Testa perfil (requer autenticaÃ§Ã£o)
	@echo "ğŸ” Testando perfil..."
	@curl -v $(APP_URL)/profile

curl-logout: ## Testa logout
	@echo "ğŸ” Testando logout..."
	@curl -v $(APP_URL)/logout

curl-callback: ## Testa callback OAuth
	@echo "ğŸ” Testando callback OAuth..."
	@curl -v $(APP_URL)/auth/callback

# Comandos de setup
setup: ## Setup completo do projeto
	@echo "ğŸš€ Setup completo do projeto..."
	@$(MAKE) install
	@$(MAKE) test-casdoor
	@echo "âœ… Setup concluÃ­do!"

# Comandos de desenvolvimento rÃ¡pido
dev-test: ## Executa aplicaÃ§Ã£o e testes em paralelo
	@echo "ğŸš€ Executando aplicaÃ§Ã£o e testes..."
	@$(MAKE) run & sleep 3 && $(MAKE) test && kill %1

# Comandos de documentaÃ§Ã£o
docs: ## Gera documentaÃ§Ã£o da API
	@echo "ğŸ“š Gerando documentaÃ§Ã£o..."
	crystal src/app.cr --docs > openapi.yml

routes: ## Lista todas as rotas
	@echo "ğŸ›£ï¸ Listando rotas..."
	crystal src/app.cr --routes
